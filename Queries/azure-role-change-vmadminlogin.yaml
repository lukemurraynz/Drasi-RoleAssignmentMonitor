kind: ContinuousQuery
apiVersion: v1
name: azure-role-change-vmadminlogin
spec:
  mode: query
  sources:
    subscriptions:
      - id: azure-role-eventhub-source
        nodes:
          - sourceLabel: eventhub1
        pipeline:
          - extract-role-assignments
  query: >
    MATCH
      (r:RoleAssignment)
    WHERE
      r.requestBody CONTAINS '1c0163c0-47e6-4577-8991-ea5c82e286e4'
    RETURN
      r.correlationId as correlationId,
      r.resourceId as resourceId,
      r.requestBody as requestBody,
      r.resultType as resultType,
      r.resultSignature as resultSignature,
      r.callerIpAddress as callerIpAddress,
      r.callerName as callerName,
      r.callerEmail as callerEmail,
      r.email as email,
      r.principalName as principalName,
      r.tenantId as tenantId,
      r.timestamp as timestamp,
      r.location as location,
      r.entity as entity,
      r.hierarchy as hierarchy,
      r.eventCategory as eventCategory,
      r.operationName as operationName
  middleware:
    - id: extract-role-assignments
      name: extract-role-assignments
      kind: unwind
      properties:
        RoleAssignment:
          - selector: $.records[*]
            label: RoleAssignment
            key: $.correlationId
            properties:
              callerIpAddress: $.callerIpAddress
              resourceId: $.resourceId
              operationName: $.operationName
              email: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress']
              principalName: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']
              tenantId: $.identity.claims['http://schemas.microsoft.com/identity/claims/tenantid']
              correlationId: $.correlationId
              # Store the raw requestbody (JSON string - needs manual parsing later)
              requestBody: $.properties.requestbody
              # Additional properties that are directly accessible
              callerName: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']
              callerEmail: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress']
              resultType: $.resultType
              resultSignature: $.resultSignature
              timestamp: $.time
              location: $.RoleLocation
              entity: $.properties.entity
              hierarchy: $.properties.hierarchy
              eventCategory: $.properties.eventCategory
