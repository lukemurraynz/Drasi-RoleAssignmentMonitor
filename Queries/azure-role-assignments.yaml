kind: ContinuousQuery
apiVersion: v1
name: azure-role-assignments
spec:
  mode: query
  sources:
    subscriptions:
      - id: azure-role-eventhub-source
        nodes:
          - sourceLabel: eventhub1
        pipeline:
          - extract-role-assignments
  middleware:
    - id: extract-role-assignments
      name: extract-role-assignments
      kind: unwind
      RoleAssignment:
        - selector: $.records[*]
          label: RoleAssignment
          key: $.correlationId
          properties:
            callerIpAddress: $.callerIpAddress
            resourceId: $.resourceId
            operationName: $.operationName
            email: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress']
            principalName: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']
            tenantId: $.identity.claims['http://schemas.microsoft.com/identity/claims/tenantid']
            # Store the raw requestbody for fallback
            requestBody: $.properties.requestbody
            # Try to extract parsed fields from requestbody JSON
            principalId: $.properties.requestbody.Properties.PrincipalId
            principalType: $.properties.requestbody.Properties.PrincipalType
            roleDefinitionId: $.properties.requestbody.Properties.RoleDefinitionId
            scope: $.properties.requestbody.Properties.Scope
            roleAssignmentId: $.properties.requestbody.Id
            # Additional properties
            callerName: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']
            callerEmail: $.identity.claims['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress']
            resultType: $.resultType
            resultSignature: $.resultSignature
            timestamp: $.time
            location: $.RoleLocation
            # Extract entity and hierarchy from properties
            entity: $.properties.entity
            hierarchy: $.properties.hierarchy
            eventCategory: $.properties.eventCategory
  query: >
    MATCH
      (r:RoleAssignment)
    RETURN
      r.correlationId as correlationId,
      r.resourceId as resourceId,
      r.principalId as principalId,
      r.principalType as principalType,
      r.roleDefinitionId as roleDefinitionId,
      r.scope as scope,
      r.roleAssignmentId as roleAssignmentId,
      r.requestBody as requestBody,
      r.resultType as resultType,
      r.resultSignature as resultSignature,
      r.callerIpAddress as callerIpAddress,
      r.callerName as callerName,
      r.callerEmail as callerEmail,
      r.email as email,
      r.principalName as principalName,
      r.tenantId as tenantId,
      r.timestamp as timestamp,
      r.location as location,
      r.entity as entity,
      r.hierarchy as hierarchy,
      r.eventCategory as eventCategory,
      r.operationName as operationName
